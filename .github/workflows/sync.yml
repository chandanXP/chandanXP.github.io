name: Portfolio Sync & Backup

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync-state:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ==========================================
      # START OF RANDOM SKIP LOGIC
      # ==========================================
      - name: Check Random Skip Status
        id: check_skip
        run: |
          # Initialize file if it doesn't exist
          if [ ! -f skip_state.txt ]; then echo "0" > skip_state.txt; fi
          
          SKIP_REMAINING=$(cat skip_state.txt)
          
          if [ "$SKIP_REMAINING" -gt 0 ]; then
            NEW_SKIP=$((SKIP_REMAINING - 1))
            echo "$NEW_SKIP" > skip_state.txt
            echo "STILL_SKIPPING=true" >> $GITHUB_ENV
            echo "Remaining skip days: $NEW_SKIP"
          else
            # Time to run! But first, pick the NEXT skip interval (1-4)
            NEXT_SKIP=$(( ( RANDOM % 4 ) + 1 ))
            echo "$NEXT_SKIP" > skip_state.txt
            echo "STILL_SKIPPING=false" >> $GITHUB_ENV
            echo "Running today. Next skip interval set to: $NEXT_SKIP days."
          fi

      - name: Commit Skip State
        if: always() # Ensure we update the counter even if we skip the rest
        run: |
          git config --global user.name "chandanXP"
          git config --global user.email "imjunior471@gmail.com"
          git add skip_state.txt
          git commit -m "Update skip counter [skip ci]" || exit 0
          git push
      # ==========================================
      # END OF RANDOM SKIP LOGIC
      # ==========================================

      - name: Fetch Real-Time Data from Firestore
        if: env.STILL_SKIPPING == 'false'
        id: fetch_data
        env:
          API_KEY: ${{ secrets.FIREBASE_API_KEY }} 
          PROJECT_ID: "chandan-saroj-portfolio"
        run: |
          TODAY=$(date +%Y-%m-%d)
          echo "Fetching data for $TODAY..."

          LIKES_JSON=$(curl -s "https://firestore.googleapis.com/v1/projects/$PROJECT_ID/databases/(default)/documents/stats/likes?key=$API_KEY")
          LIKES=$(echo "$LIKES_JSON" | jq -r '.fields.count.integerValue // 0')

          THEME_JSON=$(curl -s "https://firestore.googleapis.com/v1/projects/$PROJECT_ID/databases/(default)/documents/website_state/global_theme?key=$API_KEY")
          COLOR=$(echo "$THEME_JSON" | jq -r '.fields.primary.stringValue // "Unknown"')
          
          VIEWS_JSON=$(curl -s "https://firestore.googleapis.com/v1/projects/$PROJECT_ID/databases/(default)/documents/page_views/$TODAY?key=$API_KEY")
          VIEWS=$(echo "$VIEWS_JSON" | jq -r '.fields.views.integerValue // 0')

          MSG_JSON=$(curl -s "https://firestore.googleapis.com/v1/projects/$PROJECT_ID/databases/(default)/documents/messages?key=$API_KEY&pageSize=300")
          MSG_COUNT=$(echo "$MSG_JSON" | grep -o '"name":' | wc -l)

          echo "LIKES=$LIKES" >> $GITHUB_ENV
          echo "VIEWS=$VIEWS" >> $GITHUB_ENV
          echo "MSG_COUNT=$MSG_COUNT" >> $GITHUB_ENV
          echo "THEME_COLOR=$COLOR" >> $GITHUB_ENV
          echo "TODAY=$TODAY" >> $GITHUB_ENV

      - name: Update State Logs
        if: env.STILL_SKIPPING == 'false'
        run: |
          echo "# ðŸ“Š Live Portfolio Status" > STATE.md
          echo "Last Synced: $(date)" >> STATE.md
          echo "" >> STATE.md
          echo "| Metric | Value |" >> STATE.md
          echo "| :--- | :--- |" >> STATE.md
          echo "| ðŸ’š **Total Likes** | **$LIKES** |" >> STATE.md
          echo "| ðŸ‘ï¸ **Views (Today)** | **$VIEWS** |" >> STATE.md
          echo "| ðŸ’¬ **Total Messages** | **$MSG_COUNT** |" >> STATE.md
          echo "| ðŸŽ¨ **Current Theme** | \`$THEME_COLOR\` |" >> STATE.md
          echo "" >> STATE.md
          echo "![Chart](https://quickchart.io/chart?c={type:'bar',data:{labels:['Likes','Messages','DailyViews'],datasets:[{label:'Stats',data:[$LIKES,$MSG_COUNT,$VIEWS]}]}})" >> STATE.md

          if [ ! -f history.jsonl ]; then touch history.jsonl; fi
          JSON_DATA="{\"date\": \"$TODAY\", \"likes\": $LIKES, \"daily_views\": $VIEWS, \"total_messages\": $MSG_COUNT, \"theme\": \"$THEME_COLOR\"}"
          echo "$JSON_DATA" >> history.jsonl

      - name: Commit and Push Data
        if: env.STILL_SKIPPING == 'false'
        run: |
          git add STATE.md history.jsonl
          if git diff --staged --quiet; then
            echo "No changes in stats today."
          else
            git commit -m "Sync: $VIEWS views, $LIKES likes, $MSG_COUNT msgs ($TODAY)"
            git push
          fi
